# ターン処理順序（第4世代）

**参照元**: ポケモンwiki, Bulbapedia, Smogon
**対象世代**: 第4世代（ダイヤモンド・パール・プラチナ・ハートゴールド・ソウルシルバー）

---

## 1ターンの基本構成

1ターンは以下の5つの段階から構成される：

```
1. ポケモンを繰り出す（交代・瀕死後の強制交代）
2. コマンド選択
3. トレーナー行動と行動順確定
4. ポケモンの行動実行
5. ターン終了時の処理
```

---

## 詳細：各段階の処理順序

### 1. ポケモンを繰り出す

以下の条件でポケモンが繰り出される：

- **戦闘開始時**：先頭のポケモン
- **瀕死後**：強制的に次のポケモンを選択
- **交代技使用後**（とんぼがえり、ボルトチェンジ等）
- **ほえる/ふきとばし等で強制交代**

#### 繰り出し時の処理順序

1. 場に出る
2. **特性発動**（いかく、プレッシャー、ダウンロード等）
3. **道具発動**（該当する場合）

---

### 2. コマンド選択

プレイヤーが以下のいずれかを選択：

- **技を使う**（4つの技から選択）
- **交代**（控えのポケモンに交代）
- **道具を使う**
- **逃げる**（野生戦のみ）

---

### 3. トレーナー行動と行動順確定

#### 3-1. トレーナー道具の使用

トレーナーが道具を使用した場合、この段階で適用される（ポケモンの行動より先）。

#### 3-2. 交代の処理

交代を選択したポケモンは **必ず先に行動**（技の優先度・素早さに関係なく）。

#### 3-3. 行動順の決定（技を使う場合）

技を使用するポケモンの行動順は以下の順に決定される：

```
1. 優先度（高い順）
2. 道具効果（せんせいのツメ/イバンのみ/こうこうのしっぽ/まんぷくおこう）
3. 補正後の素早さ（高い順）
4. 乱数（同速の場合、50%ずつ）
```

**詳細は [`priority-speed.md`](./priority-speed.md) を参照。**

---

### 4. ポケモンの行動実行

確定した順序でポケモンが行動する。

#### 行動実行フロー（1匹ごと）

```
1. 行動可能性チェック
   ├─ ひるみ → 行動不能
   ├─ こんらん → 33%で自傷（物理40威力）
   ├─ メロメロ → 50%で行動不能
   ├─ まひ → 25%で行動不能
   ├─ ねむり → 行動不能（ねごと/いびき除く）
   └─ こおり → 行動不能（20%で解除）

2. 技の実行判定
   ├─ PP確認
   ├─ こだわり系アイテムの拘束チェック
   ├─ アンコール等の拘束チェック
   └─ 対象の有効性確認

3. 技の命中判定
   ├─ 必中技（例：でんじは、あまいかおり等）
   ├─ 命中率計算（ランク補正含む）
   └─ 乱数判定

4. 技の効果発動
   ├─ ダメージ計算（詳細は damage-calculation.md）
   ├─ 追加効果判定（確率判定）
   ├─ 状態異常付与
   ├─ ランク変化
   └─ 場の変化（天候・フィールド等）

5. 反動・デメリット処理
   ├─ 反動ダメージ（すてみタックル等）
   ├─ HP吸収（ドレインパンチ等）
   └─ 能力低下（オーバーヒート等）

6. 道具発動判定
   ├─ いのちのたま（ダメージ後）
   ├─ オボンのみ（HP50%以下）
   ├─ きのみ（発動条件）
   └─ レッドカード等（被弾後発動）

7. 特性発動判定
   ├─ せいでんき/ほのおのからだ（接触技被弾時）
   ├─ どくのトゲ（接触技被弾時）
   └─ その他接触系特性
```

---

### 5. ターン終了時の処理

**全てのポケモンの行動が終了した後**、以下の順序で処理が行われる。

#### ターン終了処理の順序

```
1. 天候ダメージ
   ├─ すなあらし（岩・地・鋼以外に1/16ダメージ）
   └─ あられ（氷以外に1/16ダメージ）

2. 砂嵐の特防補正（岩タイプのみ、特防1.5倍）※ターン中常時

3. 状態異常ダメージ
   ├─ やけど（1/8ダメージ）
   ├─ どく（1/8ダメージ）
   └─ もうどく（蓄積：初回1/16、2回目2/16...）

4. 呪いのダメージ（1/4ダメージ）

5. 宿り木のダメージ（1/8ダメージ → 相手回復）

6. 道具発動（ターン終了時）
   ├─ たべのこし（1/16回復）
   ├─ くろいヘドロ（毒タイプ：1/16回復 / 他：1/8ダメージ）
   └─ どくどくだま/かえんだま（状態異常付与）

7. 特性発動（ターン終了時）
   ├─ ポイズンヒール（毒状態で1/8回復）
   ├─ アイスボディ（あられ中1/16回復）
   ├─ レインディッシュ（雨中1/16回復）
   └─ かんそうはだ（晴れ中1/8ダメージ）

8. ねがいごとの回復

9. みらいよち/はめつのねがいのダメージ

10. ペリッシュカウント減少
    └─ 0になったら瀕死

11. 拘束技のダメージ（まきつく、ほのおのうず等：1/16）

12. 悪夢のダメージ（ねむり状態で1/4）

13. 場の状態のターン数カウント
    ├─ トリックルーム（5ターンで終了）
    ├─ じゅうりょく（5ターンで終了）
    ├─ 天候（5ターンで終了、岩系アイテムで8ターン）
    └─ リフレクター/ひかりのかべ（5ターンで終了）

14. 技の効果ターン数カウント
    ├─ アンコール（4〜8ターン）
    ├─ ちょうはつ（3ターン）
    └─ かなしばり等
```

---

## 重要な補足事項

### 瀕死判定のタイミング

- ダメージを受けた直後に判定
- HPが0以下になると即座に瀕死
- 瀕死になったポケモンはそれ以降の処理（ターン終了処理含む）をスキップ

### こだわり系アイテム（スカーフ/ハチマキ/メガネ）

- 最初に選んだ技に固定される
- 交代すると解除される
- 技を使う前に相手が瀕死になった場合も固定される

### まもる/みきり/こらえる

- 優先度+3
- 連続使用で成功率が下がる（1/2, 1/4, 1/8...）
- 別の技を挟むと成功率リセット

---

## 実装時の注意点

### 決定論性の保証

- 乱数は**seed固定**で完全再現可能にする
- 乱数消費順序を厳密に管理：
  1. 行動順の同速判定
  2. 命中判定
  3. ダメージ乱数
  4. 追加効果判定
  5. 急所判定

### イベントログの生成

各処理段階で適切なイベントを生成：

- `TURN_START`
- `ACTION_DECLARED`
- `PRIORITY_DETERMINED`
- `MOVE_EXECUTION_START`
- `HIT` / `MISS`
- `DAMAGE`
- `STATUS_INFLICT`
- `ABILITY_TRIGGER`
- `ITEM_TRIGGER`
- `WEATHER_DAMAGE`
- `STATUS_DAMAGE`
- `TURN_END`

---

## 参考文献

- [ポケモンwiki - ターン](https://wiki.xn--rckteqa2e.com/wiki/%E3%82%BF%E3%83%BC%E3%83%B3)
- [Bulbapedia - Turn](https://bulbapedia.bulbagarden.net/wiki/Turn)
- [Bulbapedia - Priority](https://bulbapedia.bulbagarden.net/wiki/Priority)
- [Smogon - Damage Formula](https://www.smogon.com/dp/articles/damage_formula)
