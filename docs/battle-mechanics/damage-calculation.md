# ダメージ計算式（第4世代）

**参照元**: ポケモンwiki, Bulbapedia, Smogon
**対象世代**: 第4世代（ダイヤモンド・パール・プラチナ・ハートゴールド・ソウルシルバー）

---

## 完全な計算式

第4世代のダメージ計算式は以下の通り：

```
Damage = (((((((Level × 2 ÷ 5) + 2) × Power × A ÷ 50) ÷ D) × Mod1) + 2) × CH × Mod2 × R ÷ 100) × STAB × Type1 × Type2 × Mod3)
```

**重要**: 各演算子（+, -, ×, ÷）の実行後、**小数点以下を切り捨て**してから次の演算を行う。

---

## 各パラメータの詳細

### 基本パラメータ

| パラメータ | 説明 |
|-----------|------|
| `Level` | 攻撃側のレベル |
| `Power` | 技の威力 |
| `A` | 攻撃側の攻撃 or 特攻（技の分類に依存） |
| `D` | 防御側の防御 or 特防（技の分類に依存） |

#### 物理・特殊の判定（第4世代の特徴）

第4世代では**技ごとに物理/特殊が決まっている**（タイプ依存ではない）：

- **物理技** → 攻撃側の `こうげき`、防御側の `ぼうぎょ`
- **特殊技** → 攻撃側の `とくこう`、防御側の `とくぼう`
- **変化技** → ダメージ計算なし

#### ランク補正

能力ランクが変化している場合、実数値に以下の補正を適用：

```
補正後の実数値 = 基礎実数値 × (2 + max(rank, 0)) / (2 + max(-rank, 0))
```

| ランク | 倍率 |
|-------|------|
| +6 | ×4.0 |
| +5 | ×3.5 |
| +4 | ×3.0 |
| +3 | ×2.5 |
| +2 | ×2.0 |
| +1 | ×1.5 |
| 0 | ×1.0 |
| -1 | ×0.67 |
| -2 | ×0.5 |
| -3 | ×0.4 |
| -4 | ×0.33 |
| -5 | ×0.29 |
| -6 | ×0.25 |

**急所時の特殊ルール**：
- 攻撃側の能力**マイナス補正は無視**される
- 防御側の能力**プラス補正は無視**される

---

## 補正値の詳細（Mod1, Mod2, Mod3）

### Mod1（事前補正）

```
Mod1 = Burn × Screen × Targets × Weather × FF
```

各補正は**掛け算**で適用される。

| 補正 | 条件 | 倍率 |
|------|------|------|
| **Burn** | やけど状態で物理技を使用 | ×0.5 |
| **Screen** | リフレクター（物理）/ ひかりのかべ（特殊） | ×0.5（ダブル:×0.66） |
| **Targets** | 全体攻撃技（ダブル/トリプル） | ×0.75 |
| **Weather** | 晴れ（炎技）/ 雨（水技） | ×1.5 |
|  | 晴れ（水技）/ 雨（炎技） | ×0.5 |
| **FF** | もらいび発動後の炎技 | ×1.5 |

**補足**：
- やけど補正は「からぶり保険」「こんじょう」で無効化される場合あり
- 壁補正はダブルバトルで異なる（×0.66）

---

### CH（急所補正）

| 条件 | 倍率 |
|------|------|
| 急所ヒット + スナイパー特性 | ×3 |
| 急所ヒット（通常） | ×2 |
| 急所なし | ×1 |

#### 急所率

急所ランクに応じて確率が変化：

| 急所ランク | 確率 |
|----------|------|
| 0 | 1/16 (6.25%) |
| +1 | 1/8 (12.5%) |
| +2 | 1/4 (25%) |
| +3 | 1/3 (33.3%) |
| +4以上 | 1/2 (50%) |

**急所ランク上昇条件**：
- きあいだめ、ハイパービーム等：+1
- ピントレンズ/するどいツメ：+1
- きょううん特性：+1
- つじぎり、リーフブレード等：技自体が+1

---

### Mod2（中間補正）

```
Mod2 = Item × First
```

| 補正 | 条件 | 倍率 |
|------|------|------|
| **Item (いのちのたま)** | 攻撃後に最大HPの1/10ダメージ | ×1.3 |
| **Item (メトロノーム)** | 同じ技を連続使用 | ×1.0〜2.0（1.1, 1.2, ...） |
| **First (さきどり)** | さきどり成功 | ×1.5 |

**補足**：
- こだわりハチマキ/メガネは**攻撃/特攻のランク補正**として扱われる（Mod2ではない）
- メトロノームは5回目以降も×2.0で固定

---

### R（乱数補正）

```
R = 85〜100の乱数（一様分布）
```

- 16段階の離散値：85, 86, 87, ..., 99, 100
- 各値の確率は **1/16 (6.25%)**
- **最小ダメージ**: `Damage × 0.85`
- **最大ダメージ**: `Damage × 1.00`

---

### STAB（タイプ一致補正）

| 条件 | 倍率 |
|------|------|
| 技のタイプと使用者のタイプが一致 + てきおうりょく特性 | ×2.0 |
| 技のタイプと使用者のタイプが一致 | ×1.5 |
| 不一致 | ×1.0 |

---

### Type1, Type2（タイプ相性）

防御側が複合タイプの場合、**2つのタイプ相性を掛け合わせる**。

#### タイプ相性倍率

| 相性 | 倍率 |
|------|------|
| 効果抜群 | ×2 |
| 等倍 | ×1 |
| いまひとつ | ×0.5 |
| 無効 | ×0 |

**例**：
- ドラゴン/飛行（例：カイリュー）に氷技
  - ドラゴン→氷：×2
  - 飛行→氷：×2
  - 合計：×4

---

### Mod3（事後補正）

```
Mod3 = SRF × EB × TL × Berry
```

| 補正 | 条件 | 倍率 |
|------|------|------|
| **SRF** | 効果抜群 + ハードロック/フィルター（攻撃側がかたやぶりでない） | ×0.75 |
| **EB** | 効果抜群 + たつじんのおび | ×1.2 |
| **TL** | いまひとつ + いろめがね特性 | ×2 |
| **Berry** | 効果抜群 + 半減の実 | ×0.5 |

**補足**：
- 半減の実は**1度だけ発動**して消費される
- 複数の補正が同時に適用される場合、掛け算で計算

---

## 計算手順の例

### 例：ガブリアスの地震 vs カイリュー

**前提**：
- ガブリアス（攻撃252振り、いじっぱり、Lv50）
- カイリュー（HP252振り、Lv50）
- 天候なし、壁なし、急所なし

#### パラメータ

- Level = 50
- Power = 100
- A = 182（ガブリアス攻撃実数値）
- D = 115（カイリュー防御実数値）
- Mod1 = 1.0
- CH = 1 (急所なし)
- Mod2 = 1.0
- R = 100（最大乱数）
- STAB = 1.5（地面タイプ一致）
- Type1 = 1.0（地面→ドラゴン）
- Type2 = 1.0（地面→飛行）
- Mod3 = 1.0

#### 計算

```
1. (50 × 2 ÷ 5) = 20
2. 20 + 2 = 22
3. 22 × 100 = 2200
4. 2200 × 182 = 400400
5. 400400 ÷ 50 = 8008
6. 8008 ÷ 115 = 69 (切り捨て)
7. 69 × 1.0 = 69
8. 69 + 2 = 71
9. 71 × 1 = 71 (CH)
10. 71 × 1.0 = 71 (Mod2)
11. 71 × 100 ÷ 100 = 71 (R=100)
12. 71 × 1.5 = 106 (切り捨て, STAB)
13. 106 × 1.0 = 106 (Type1)
14. 106 × 1.0 = 106 (Type2)
15. 106 × 1.0 = 106 (Mod3)
```

**結果**: 106ダメージ（最大乱数時）

乱数85の場合：`71 × 85 ÷ 100 = 60 → 60 × 1.5 = 90ダメージ`

**ダメージ範囲**: 90〜106（確定2発）

---

## 最小ダメージ保証

計算結果が0の場合でも、**無効タイプでなければ1ダメージ**は与える。

例：
- 攻撃1のコイキングのたいあたり
- 計算結果が0でも、ノーマル技が無効でなければ1ダメージ

---

## 実装時の注意点

### 切り捨てのタイミング

**各演算子の直後に切り捨て**を行う。以下は誤り：

```
❌ 間違い: 最後にまとめて切り捨て
✅ 正解: 演算ごとに切り捨て
```

### 計算順序の厳守

式の左から右へ順番に計算し、**演算子の優先順位（BODMAS）を無視**できる。

### テストケース

以下の有名な確定数をテストケースに含める：

- ガブリアスの地震でカイリュー確2
- スカーフガブリアスの逆鱗でラティオス確1
- メタグロスのコメットパンチでスイクン確3

---

## 参考文献

- [ポケモンwiki - ダメージ](https://wiki.xn--rckteqa2e.com/wiki/%E3%83%80%E3%83%A1%E3%83%BC%E3%82%B8)
- [Bulbapedia - Damage](https://bulbapedia.bulbagarden.net/wiki/Damage)
- [Smogon - Damage Formula (DP)](https://www.smogon.com/dp/articles/damage_formula)
