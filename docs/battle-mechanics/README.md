# 第4世代バトルメカニクス仕様書

本ディレクトリは、ポケモン第4世代（ダイヤモンド・パール・プラチナ・ハートゴールド・ソウルシルバー）のバトルメカニクスを**完全に準拠**するための仕様書です。

---

## 目的

- **実装の正確性を保証**：オリジナルの解釈ではなく、公式仕様に基づく実装
- **決定論性の基盤**：再現可能なバトルシミュレーションの前提
- **テストケースの根拠**：期待値の正当性を担保
- **互換性の確保**：第4世代の挙動を完全に再現

---

## 参照元

本仕様書は以下の信頼できる情報源に基づいています：

- [ポケモンwiki](https://wiki.xn--rckteqa2e.com/)
- [Bulbapedia](https://bulbapedia.bulbagarden.net/)
- [Smogon University](https://www.smogon.com/)

---

## 文書一覧

### 1. [ターン処理順序](./turn-order.md)

**内容**：
- 1ターンの基本構成（5段階）
- ポケモンを繰り出す処理
- 行動順の決定ルール
- 行動実行フロー
- **ターン終了時の処理順序（14段階）**

**重要性**：★★★★★
- 全ての実装の基盤
- 処理順序の誤りは致命的なバグに直結

---

### 2. [ダメージ計算式](./damage-calculation.md)

**内容**：
- 完全な計算式（Mod1, Mod2, Mod3の詳細）
- 物理/特殊の判定（第4世代は技依存）
- 各補正の適用順序
- 乱数補正（85〜100）
- 切り捨てのタイミング
- 実装例とテストケース

**重要性**：★★★★★
- ダメージ計算の正確性は対戦の核心
- belief tracker（相手推定）の前提

---

### 3. [優先度と素早さ](./priority-speed.md)

**内容**：
- 優先度システム（-7〜+5）
- 素早さの計算と補正
- 道具効果（せんせいのツメ、スカーフ等）
- 同速判定（乱数）
- トリックルーム下の挙動

**重要性**：★★★★
- 行動順の決定は戦略の根幹
- 先手後手の観測は belief tracker に直結

---

### 4. [状態異常](./status-conditions.md)

**内容**：
- 6種の状態異常（まひ/やけど/どく/もうどく/こおり/ねむり）
- 各状態異常の効果と発動タイミング
- 付与・回復方法
- 特殊ケース（特性との相互作用）
- ターン終了時のダメージ処理順序

**重要性**：★★★★
- 状態異常は長期戦の鍵
- ターン終了処理の正確性が重要

---

## 実装時の原則

### 1. **仕様書を真理の源泉とする**

```
実装 ← 仕様書（本ディレクトリ） ← 公式情報源
```

- 実装前に該当する仕様書を必ず参照
- 不明点があれば仕様書を更新
- オリジナルの解釈を避ける

---

### 2. **決定論性の保証**

- **seed固定で完全再現**
- 乱数消費順序を厳密に管理
- 浮動小数点演算を避ける（整数演算 + 切り捨て）

---

### 3. **イベントログの生成**

全ての観測可能な情報を `EventLog` として出力：

```typescript
enum EventType {
  // ターン制御
  TURN_START,
  ACTION_DECLARED,
  PRIORITY_DETERMINED,

  // 技実行
  MOVE_EXECUTION_START,
  HIT,
  MISS,
  DAMAGE,

  // 状態変化
  STATUS_INFLICT,
  STATUS_CURE,
  ABILITY_TRIGGER,
  ITEM_TRIGGER,

  // ターン終了
  WEATHER_DAMAGE,
  STATUS_DAMAGE,
  TURN_END,
}
```

---

### 4. **テスト駆動開発**

仕様書に基づくテストケースを先に作成：

```typescript
describe('Damage Calculation', () => {
  it('ガブリアスの地震 vs カイリュー（確定2発）', () => {
    // 仕様書の例に基づく期待値
    expect(damage).toBeInRange(90, 106);
  });
});
```

---

## 仕様の拡張

新しいメカニクスを追加する場合：

1. **公式情報源を確認**（ポケモンwiki, Bulbapedia等）
2. **新しい文書を作成** or 既存文書を更新
3. **参照元を明記**
4. **実装例とテストケースを含める**

### 追加予定の文書

- `weather.md`：天候システムの詳細
- `abilities.md`：特性の発動タイミング
- `items.md`：道具の効果と発動条件
- `moves-special.md`：特殊な技の挙動（みがわり、まもる等）
- `hazards.md`：ステルスロック、どくびし等の設置技

---

## 実装チェックリスト

### Milestone 1（最小戦闘）

- [ ] ダメージ計算式の実装（物理/特殊区分含む）
- [ ] 優先度・素早さによる行動順決定
- [ ] 基本的なイベントログ生成
- [ ] seed固定での再現性

### Milestone 2（ルール拡張）

- [ ] 状態異常の実装（全6種）
- [ ] ターン終了処理の実装（14段階）
- [ ] 道具効果（スカーフ、たべのこし等）
- [ ] 特性（基礎のみ）
- [ ] 回帰テスト（有名な確定数）

---

## 貢献ガイドライン

仕様書の誤りを発見した場合：

1. **Issue を作成**（参照元のURLを含める）
2. **正しい仕様を提案**（公式情報源へのリンク必須）
3. **影響範囲を明記**（実装のどの部分に影響するか）

---

## ライセンス

本仕様書は公式情報源に基づく事実の記述であり、独自の創作物ではありません。
ポケモンは任天堂・クリーチャーズ・ゲームフリークの登録商標です。

---

**最終更新**: 2026-01-25
