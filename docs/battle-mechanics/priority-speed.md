# 優先度と素早さ（第4世代）

**参照元**: ポケモンwiki, Bulbapedia
**対象世代**: 第4世代（ダイヤモンド・パール・プラチナ・ハートゴールド・ソウルシルバー）

---

## 行動順の決定ルール

技を使用するポケモンの行動順は以下の**優先順位**で決定される：

```
1. 優先度（技固有の値、高い順）
2. 道具効果（せんせいのツメ等）
3. 補正後の素早さ（高い順）
4. 乱数（同速の場合、50%ずつ）
```

**重要**: 交代は**全ての技より先**に実行される。

---

## 1. 優先度（Priority）

### 優先度の基本

- 各技には**-7〜+5**の優先度が設定されている
- 優先度が高い技ほど先に行動する
- **同じ優先度**内では素早さで判定

### 第4世代の主要な優先度

| 優先度 | 代表的な技 |
|-------|-----------|
| **+5** | てだすけ |
| **+3** | まもる、みきり、こらえる、ファストガード、ワイドガード |
| **+2** | フェイント、しんそく（第5世代以降+2に変更） |
| **+1** | でんこうせっか、マッハパンチ、バレットパンチ、こおりのつぶて、アクアジェット、かげうち、しんくうは |
| **0** | 通常の技（大多数） |
| **-1** | ともえなげ、ほえる |
| **-3** | きあいパンチ |
| **-4** | ゆきなだれ、リベンジ |
| **-5** | カウンター、ミラーコート |
| **-7** | トリックルーム |

### 優先度の変化

以下の技・特性で優先度が変化する：

| 技/特性 | 効果 |
|--------|------|
| **トリックルーム** | 5ターン、優先度の順序が逆転（素早さも逆転） |

**注意**: 第4世代では、戦闘中の優先度変化は**次のターンから**適用される。

---

## 2. 道具効果（行動順に影響）

優先度が同じ場合、以下の道具が行動順に影響する：

| 道具 | 効果 | 発動確率/条件 |
|------|------|--------------|
| **せんせいのツメ** | 優先度に関係なく先制 | 20% |
| **イバンのみ** | HPが1/4以下で先制（1度きり） | 条件満たせば100% |
| **こうこうのしっぽ** | 必ず後攻になる | 100% |
| **まんぷくおこう** | 必ず後攻になる | 100% |

### 道具の優先順位

同じ優先度で複数の道具効果が競合する場合：

```
1. せんせいのツメ/イバンのみ（先制）
2. 通常の素早さ判定
3. こうこうのしっぽ/まんぷくおこう（後攻）
```

**例**：
- 両者ともせんせいのツメ発動 → 素早さで判定
- Aがせんせいのツメ、Bがこうこうのしっぽ → A先制

---

## 3. 素早さ（Speed）

### 素早さの計算

```
実効素早さ = 種族値素早さ × 性格補正 × 努力値補正 × ランク補正 × 状態補正 × 道具補正 × 特性補正
```

### 素早さのランク補正

| ランク | 倍率 |
|-------|------|
| +6 | ×4.0 |
| +5 | ×3.5 |
| +4 | ×3.0 |
| +3 | ×2.5 |
| +2 | ×2.0 |
| +1 | ×1.5 |
| 0 | ×1.0 |
| -1 | ×0.67 |
| -2 | ×0.5 |
| -3 | ×0.4 |
| -4 | ×0.33 |
| -5 | ×0.29 |
| -6 | ×0.25 |

### 素早さに影響する状態異常

| 状態 | 効果 |
|------|------|
| **まひ** | 素早さ**×0.25**（1/4に低下） |

### 素早さに影響する道具

| 道具 | 効果 |
|------|------|
| **こだわりスカーフ** | 素早さ×1.5 |
| **くろいてっきゅう** | 素早さ×0.5 |
| **パワー系アイテム**（努力値振り用） | 素早さ×0.5 |

### 素早さに影響する特性

| 特性 | 効果 | 条件 |
|------|------|------|
| **すいすい** | 素早さ×2 | 雨天候 |
| **ようりょくそ** | 素早さ×2 | 晴れ天候 |
| **すなかき** | 素早さ×2 | 砂嵐天候 |
| **ゆきかき** | 素早さ×2 | あられ天候 |
| **はやあし** | 素早さ×1.5 | 状態異常 |
| **スロースタート** | 攻撃・素早さ×0.5 | 場に出て5ターン |

### 素早さに影響する技

| 技 | 効果 |
|---|------|
| **トリックルーム** | 5ターン、素早さ順が逆転（遅い方が先） |
| **おいかぜ** | 4ターン、味方の素早さ×2 |
| **でんじは** | 相手をまひ状態に（素早さ×0.25） |

---

## 4. 同速判定（乱数）

素早さが完全に一致した場合、**50%の確率**でどちらが先に行動するかが決まる。

### 同速の条件

以下が全て等しい場合に同速：

```
補正後の素早さ実数値が完全一致
```

### 乱数の生成

- 決定論的な擬似乱数生成器（PRNG）を使用
- **seed固定**で完全再現可能

---

## 実装例：行動順の決定

```typescript
function determineActionOrder(pokemon1: Pokemon, pokemon2: Pokemon, rng: RNG): Pokemon[] {
  // 1. 優先度比較
  const priority1 = getPriority(pokemon1.selectedMove);
  const priority2 = getPriority(pokemon2.selectedMove);

  if (priority1 > priority2) return [pokemon1, pokemon2];
  if (priority1 < priority2) return [pokemon2, pokemon1];

  // 2. 道具効果（せんせいのツメ等）
  const item1Triggers = checkPriorityItem(pokemon1, rng);
  const item2Triggers = checkPriorityItem(pokemon2, rng);

  if (item1Triggers && !item2Triggers) return [pokemon1, pokemon2];
  if (!item1Triggers && item2Triggers) return [pokemon2, pokemon1];

  // 3. 素早さ比較
  const speed1 = getEffectiveSpeed(pokemon1);
  const speed2 = getEffectiveSpeed(pokemon2);

  if (speed1 > speed2) return [pokemon1, pokemon2];
  if (speed1 < speed2) return [pokemon2, pokemon1];

  // 4. 同速（乱数）
  return rng.nextBoolean() ? [pokemon1, pokemon2] : [pokemon2, pokemon1];
}
```

---

## トリックルーム下での行動順

トリックルームが発動している場合：

```
1. 優先度は**逆転しない**（高い優先度が先）
2. 同じ優先度内で素早さが**逆転**（遅い方が先）
3. 同速判定は通常通り50%
```

**例**：
- 通常：でんこうせっか（+1、S100） > でんこうせっか（+1、S50）
- トリルーム：でんこうせっか（+1、S50） > でんこうせっか（+1、S100）

---

## テストケース

### ケース1：優先度差

- A: でんこうせっか（+1、S100）
- B: なみのり（0、S200）
- **結果**: A先攻（優先度差）

### ケース2：同優先度、素早さ差

- A: 10まんボルト（0、S100）
- B: れいとうビーム（0、S80）
- **結果**: A先攻（素早さ差）

### ケース3：こだわりスカーフ

- A: じしん（0、S80、スカーフ） → 実効S=120
- B: なみのり（0、S100）
- **結果**: A先攻（スカーフ補正）

### ケース4：まひ状態

- A: 10まんボルト（0、S100、まひ） → 実効S=25
- B: れいとうビーム（0、S80）
- **結果**: B先攻（まひ補正）

### ケース5：同速

- A: なみのり（0、S100）
- B: 10まんボルト（0、S100）
- **結果**: 50%ずつ（乱数）

---

## 実装時の注意点

### 乱数消費の順序

行動順決定で乱数を消費する場合、**必ず同速判定のみ**で消費する。
優先度・道具判定・素早さ比較では乱数を消費しない。

### せんせいのツメの乱数

20%判定は**各ポケモンごとに独立**して行う。

### イベントログ

以下のイベントを生成：

- `PRIORITY_DETERMINED`: 行動順が確定
- `QUICK_CLAW_ACTIVATED`: せんせいのツメ発動
- `CUSTAP_BERRY_ACTIVATED`: イバンのみ発動

---

## 参考文献

- [ポケモンwiki - ターン](https://wiki.xn--rckteqa2e.com/wiki/%E3%82%BF%E3%83%BC%E3%83%B3)
- [Bulbapedia - Priority](https://bulbapedia.bulbagarden.net/wiki/Priority)
- [Bulbapedia - Speed](https://bulbapedia.bulbagarden.net/wiki/Speed)
